<!DOCTYPE html>
<html lang="en">
<head>
    <!--<link rel="icon" href="data:,">-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow Pro Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            display: none; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn-loading { pointer-events: none; opacity: 0.7; }
    </style>
</head>

<body class="bg-gray-100 p-4 md:p-8">
    
    <div id="authSection" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm">
            <h2 id="authTitle" class="text-3xl font-bold mb-2 text-blue-600">Login</h2>
            <p id="authSub" class="text-gray-400 text-sm mb-6">Welcome back to TaskFlow</p>
            
            <div class="space-y-4">
                <input type="text" id="authUser" placeholder="Username" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-400 outline-none">
                <input type="password" id="authPass" placeholder="Password" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-400 outline-none">
                <button onclick="handleAuth()" id="authBtn" class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 transition">Login</button>
                
                <p class="text-center text-sm text-gray-500">
                    <span id="toggleText">Need an account?</span> 
                    <a href="#" onclick="toggleAuthMode()" id="authToggle" class="text-blue-600 font-bold underline ml-1">Signup</a>
                </p>
            </div>
        </div>
    </div>

    <div id="dashboard" class="max-w-md mx-auto bg-white p-6 rounded-2xl shadow-lg relative" style="display: none;">
        
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="text-2xl font-bold text-blue-600">TaskFlow Pro</h1>
                <p id="userGreeting" class="text-[10px] text-gray-400 font-bold uppercase tracking-widest"></p>
            </div>
            <button onclick="logout()" class="text-[10px] bg-gray-100 px-2 py-1 rounded font-bold text-gray-500 hover:bg-red-50 hover:text-red-500 transition">LOGOUT</button>
        </div>

        <div id="statsBar" class="grid grid-cols-3 gap-2 mb-6 text-center">
            <div class="bg-blue-50 p-2 rounded-xl border border-blue-100">
                <p class="text-[10px] text-blue-500 uppercase font-bold">Total</p>
                <p id="totalTasks" class="text-lg font-bold text-blue-700">0</p>
            </div>
            <div class="bg-green-50 p-2 rounded-xl border border-green-100">
                <p class="text-[10px] text-green-500 uppercase font-bold">Score</p>
                <p id="completionScore" class="text-lg font-bold text-green-700">0%</p>
            </div>
            <div class="bg-yellow-50 p-2 rounded-xl border border-yellow-100">
                <p class="text-[10px] text-yellow-600 uppercase font-bold">Pending</p>
                <p id="pendingTasks" class="text-lg font-bold text-yellow-700">0</p>
            </div>
        </div>

        <div id="status" class="text-[10px] font-semibold mb-4 text-gray-400 uppercase tracking-widest">‚óè API Online</div>

        <div class="space-y-4 mb-4">
            <div class="bg-white border rounded-xl p-2 shadow-sm focus-within:ring-2 focus-within:ring-blue-400 transition">
                <div class="flex items-center gap-2">
                    <input type="file" id="mediaInput" style="display: none;" accept="image/*,video/*,audio/*,gif,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip,.rar,.7z">
                    <button onclick="document.getElementById('mediaInput').click()" class="p-2 text-gray-400 hover:bg-gray-100 rounded-full transition">üìé</button>
                    <input id="taskInput" type="text" placeholder="Share something..." class="flex-1 border-none focus:ring-0 text-sm outline-none bg-transparent">
                    <div class="w-full bg-gray-200 rounded-full h-4 mb-2 overflow-hidden">
                    <div id="uploadProgress" class="bg-blue-600 h-full text-[10px] text-white text-center leading-4 transition-all" style="width: 0%"></div>
                    </div>
                    <button id="sendBtn" onclick="addTask()" class="flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg font-bold">
                        <span id="btnText">Send</span>
                        <div id="loader" class="spinner"></div>
                    </button>
                </div>
                <div id="filePreview" class="ml-10 mt-1 space-y-1" style ="display: none;">
                    <p id="selectedFileName" class="text-[10px] text-gray-500 font-bold italic"></p>
                    <div id="thumbPreview" class="w-16 h-16 ...">
                       <img id="thumbImg" ...>
                       <span id="thumbPlaceholder" ...>üìÑ</span>
                    </div>
                    <a id="previewDownload" ...>üì• Download</a>
                <!-- ‚úÖ THUMBNAIL PREVIEW -->
        <div id="thumbPreview" class="w-16 h-16 rounded-lg overflow-hidden bg-gray-100 flex items-center justify-center">
                <img id="thumbImg" class="w-full h-full object-cover" style="display:none;">
                <span id="thumbPlaceholder" class="text-gray-400 text-xs">üìÑ</span>
            </div>
                <!-- ‚úÖ DOWNLOAD LINK -->
            <a id="previewDownload" href="#" download class="text-[10px] text-blue-500 font-medium hover:text-blue-700">üì• Download</a>
        </div>
            </div>
            <input id="searchInput" type="text" oninput="fetchTasks()" placeholder="üîç Search tasks..." class="w-full border p-2 rounded-xl focus:outline-none text-sm bg-gray-50">
        </div>

        <ul id="taskList" class="space-y-3"></ul>

        <div id="adminSection" class="mt-8 pt-4 border-t-2 border-red-100" style="display: none;">
    <button id="realWipeBtn" onclick="clearAllTasks()" 
        style="width: 100%; padding: 14px; background-color: #fee2e2; color: #b91c1c; 
               border: 2px solid #fecaca; border-radius: 12px; font-weight: 900; 
               cursor: pointer; text-transform: uppercase; letter-spacing: 1px; 
               font-size: 11px; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);">
        ‚ö†Ô∏è WIPE GLOBAL DATABASE (ADMIN ONLY)
    </button>
    <p class="text-[10px] text-center text-gray-400 mt-4 italic">
        Syncing as <span id="displayUser" class="font-bold text-blue-400">...</span>
    </p>
</div>

<script>
    console.log("DEBUG: Current User:", localStorage.getItem('username'));
    console.log("DEBUG: Is Admin State:", localStorage.getItem('isAdmin'));
    const API_BASE_URL = "https://taskflow-backendprosecure.onrender.com";
    let isLoginMode = true;

    // --- 1. AUTHENTICATION LOGIC ---
    // helper function
    function escapeHtml(text) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return text.replace(/[&<>"']/g, m => map[m]);
    }

    // ‚úÖ HELPER FUNCTION - Add this with your other functions
    function showFilePreview(response) {
    const thumbPreview = document.getElementById('thumbPreview');
    const thumbImg = document.getElementById('thumbImg');
    const thumbPlaceholder = document.getElementById('thumbPlaceholder');
    const previewDownload = document.getElementById('previewDownload');
    const url = response.media_url;
    const ext = response.media_extension ? response.media_extension.replace('.', '').toLowerCase() : "file";

    
    // Show thumbnail based on media type
    /*if(response.media_type?.includes('video')) {
        thumbImg.src = response.media_url.replace('raw/upload/', 'video/upload/so_1/').replace(/.[^/.]+$/, '.jpg');
    } else {
        thumbImg.src = response.media_url.replace('raw/upload/', 'image/upload/w_200,h_200,c_thumb/');
    }*/

    if (!thumbImg || !response.media_url) return;
    // Reset visibilty
    thumbImg.style.display = 'none';
    thumbPlaceholder.style.display = 'block';
    thumbPlaceholder.textContent = 'üìÑ'; // Default icon

    // only try to show a thumbnail if it's an image or video (Cloudinary can generate these)
    /*if (response.media_type?.includes('image')) {
        thumbImg.src = response.media_url.replace('raw/upload/', 'image/upload/w_200,h_200,c_thumb/');
        thumbImg.style.display = 'block';
        thumbPlaceholder.style.display = 'none';
    } else if (response.media_type?.includes('video')) {
        thumbImg.src = response.media_url.replace('raw/upload/', 'video/upload/so_1,w_200,h_200,c_thumb/').replace(/\.[^/.]+$/, '.jpg');
        thumbImg.style.display = 'block';
        thumbPlaceholder.style.display = 'none';
    }*/
    if (response.media_type?.includes('image')) {
        thumbImg.src = url;
        thumbImg.style.display = 'block';
        thumbPlaceholder.style.display = 'none';
    } else if (ext === 'pdf') {
        thumbPlaceholder.innerText = "üìï";
    } else if (['xls', 'xlsx'].includes(ext)) {
        thumbPlaceholder.innerText = "üìó";
    } else if (['doc', 'docx'].includes(ext)) {
        thumbPlaceholder.innerText = "üìò";
    }

    
    thumbImg.src = response.media_url;  // Safe set
    previewDownload.href = response.media_url || url;
    previewDownload.textContent = `üì• ${response.original_filename || 'Download file'}`;
    previewDownload.download = response.original_filename || 'file';
    previewDownload.style.display = 'block';
    }

    function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        document.getElementById('authTitle').innerText = isLoginMode ? 'Login' : 'Sign Up';
        document.getElementById('authSub').innerText = isLoginMode ? 'Welcome back to TaskFlow' : 'Create your secure account';
        document.getElementById('authBtn').innerText = isLoginMode ? 'Login' : 'Create Account';
        document.getElementById('authToggle').innerText = isLoginMode ? "Signup" : "Login";
        document.getElementById('toggleText').innerText = isLoginMode ? "Need an account?" : "Already have an account?";
    }

    async function handleAuth() {
        const username = document.getElementById('authUser').value;
        const password = document.getElementById('authPass').value;
        const endpoint = isLoginMode ? '/login' : '/signup';

        if(!username || !password) return alert("Please fill all fields");

        try {
            const res = await fetch(`${API_BASE_URL}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();

            if (res.ok) {
                if (isLoginMode) {
                    localStorage.setItem('token', data.access_token);
                    localStorage.setItem('username', username);
                    localStorage.setItem('isAdmin', data.is_admin);
                    showDashboard();
                } else {
                    alert("Account created! Now please login.");
                    toggleAuthMode();
                }
            } else {
                alert(data.detail || "Authentication Failed");
            }
        } catch (err) { alert("Server Offline"); }
    }

    function showDashboard() {
    document.getElementById('authSection').style.display = 'none';
    document.getElementById('dashboard').style.display = 'block';
    
    const isAdmin = localStorage.getItem('isAdmin') === 'true';
    const adminSection = document.getElementById('adminSection');

    if (isAdmin) {
        // Show the whole container, the button inside is already styled to show
        adminSection.style.display = 'block';
        console.log("Admin verified: Showing Wipe Controls.");
    } else {
        adminSection.style.display = 'none';
    }

    document.getElementById('displayUser').innerText = localStorage.getItem('username');
    document.getElementById('userGreeting').innerText = `Hello, ${localStorage.getItem('username')}`;
    
    fetchTasks();
}

    function logout() {
        localStorage.clear();
        location.reload();
    }

    // --- 2. TASK LOGIC ---
    async function toggleComplete(id) {
    const token = localStorage.getItem('token');
    try {
        const res = await fetch(`${API_BASE_URL}/tasks/${id}/toggle`, {
            method: 'PATCH', // Assumes you have a toggle route on your backend
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
            fetchTasks(); // Refresh list to show the checkmark
        }
    } catch (err) {
        console.error("Toggle failed", err);
    }
}
    

    async function fetchTasks() {
        const searchTerm = document.getElementById('searchInput').value;
        const token = localStorage.getItem('token');
        const list = document.getElementById('taskList');
        /*const tasks = await response.json();
        
        tasks.forEach(task => {task.media_extension = task.media_extension || ''; task.media_type = task.media_type || ''; task.original_filename = task.original_filename || '';});*/

        try {
            const res = await fetch(`${API_BASE_URL}/tasks?Search=${searchTerm}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const tasks = await res.json();
            tasks.forEach(task => {task.media_extension = task.media_extension || ''; task.media_type = task.media_type || ''; task.original_filename = task.original_filename || '';});
            const list = document.getElementById('taskList');

            list.innerHTML = tasks.map(task => renderTask(task)).join('');
            updateStats();
            document.getElementById('status').innerText = "‚óè API Online";
        } catch (err) { console.error("Fetch failed");
            list.innerHTML = '<li class="text-center py-8 text-gray-400">Connection Failed.Check network.</li>';
            document.getElementById('status').innerText = "‚óè API Offline";
        }
    }

function renderTask(task) {
    let mediaHtml = "";
    const currentUser = localStorage.getItem('username');
    const isAdmin = localStorage.getItem('isAdmin') === 'true';

    if (task.media_url) {
        const url = task.media_url;
        // 1. Get extension safely from URL if metadata is missing
        let ext = task.media_extension ? task.media_extension.replace('.', '').toLowerCase() : "";
        if (!ext) {
            ext = url.split('.').pop().split(/\#|\?/)[0].toLowerCase();
        }

        let previewContent = "";
        
        // 2. Identify Group
        const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext);
        const isVideo = ['mp4', 'webm', 'mov', 'm4v'].includes(ext);
        const isAudio = ['mp3', 'wav', 'ogg', 'm4a'].includes(ext);

        if (isImage) {
            // Use Cloudinary thumbnail transform for speed
            const thumbUrl = url.includes('upload/') ? url.replace('upload/', 'upload/w_400,c_limit/') : url;
            previewContent = `<img src="${thumbUrl}" class="rounded-xl w-full border shadow-sm cursor-zoom-in" onclick="window.open('${url}')">`;
        } 
        else if (isVideo) {
            previewContent = `<video controls class="rounded-xl w-full bg-black shadow-inner"><source src="${url}"></video>`;
        } 
        else if (isAudio) {
            previewContent = `<div class="p-3 bg-white border rounded-xl"><audio controls class="w-full h-8"><source src="${url}"></audio></div>`;
        } 
        else {
            // 3. Document/File Icon Mapping
            let icon = "üìÑ";
            let color = "bg-gray-50 text-gray-500 border-gray-200";
            
            if (['pdf'].includes(ext)) { icon = "üìï"; color = "bg-red-50 text-red-600 border-red-100"; }
            else if (['doc', 'docx'].includes(ext)) { icon = "üìò"; color = "bg-blue-50 text-blue-600 border-blue-100"; }
            else if (['xls', 'xlsx', 'csv'].includes(ext)) { icon = "üìó"; color = "bg-green-50 text-green-600 border-green-100"; }
            else if (['zip', 'rar', '7z'].includes(ext)) { icon = "üì¶"; color = "bg-purple-50 text-purple-600 border-purple-100"; }
            else if (['ppt', 'pptx'].includes(ext)) { icon = "üìô"; color = "bg-orange-50 text-orange-600 border-orange-100"; }

            previewContent = `
                <div class="flex items-center gap-4 p-4 ${color} rounded-2xl border-2 border-dashed cursor-pointer hover:bg-opacity-80 transition-all" onclick="window.open('${url}')">
                    <div class="text-3xl">${icon}</div>
                    <div class="flex flex-col overflow-hidden">
                        <span class="text-[9px] font-black uppercase tracking-widest opacity-60">${ext || 'FILE'}</span>
                        <span class="text-xs font-bold truncate">${task.original_filename || 'View Resource'}</span>
                    </div>
                </div>`;
        }

        mediaHtml = `
            <div class="mt-3">
                ${previewContent}
                <button onclick="downloadFile('${url}', '${task.original_filename || 'file'}')"
                        class="mt-2 inline-flex items-center px-3 py-1 bg-gray-100 text-gray-500 rounded-full text-[9px] font-black hover:bg-blue-600 hover:text-white transition-all uppercase">
                    Download Asset üì•
                </button>
            </div>`;
    }

    const deleteBtn = (task.owner === currentUser || isAdmin) 
        ? `<button onclick="deleteTask(${task.id})" class="text-gray-300 hover:text-red-500 transition-colors ml-2">‚úï</button>` 
        : "";

    return `
        <li class="task-item bg-white p-4 rounded-2xl border border-gray-100 shadow-sm mb-4">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-[9px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-black uppercase">${task.owner}</span>
                        <span class="text-[9px] text-gray-400 font-bold">${new Date(task.created_at).toLocaleDateString()}</span>
                    </div>
                    <p class="text-sm font-medium text-gray-800">${escapeHtml(task.text)}</p>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="toggleComplete('${task.id}')" 
                            class="p-2 rounded-full ${task.is_completed ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'} transition-all border-0">
                        ${task.is_completed ? '‚úÖ' : '‚óã'}
                    </button>
                    ${deleteBtn}
                </div>
            </div>
            ${mediaHtml}
        </li>
    `;
}

/*async function addTask() {
    const text = document.getElementById('taskInput').value;
    const file = document.getElementById('mediaInput').files[0];
    const token = localStorage.getItem('token');
    
    if(!text && !file) return;

    const loader = document.getElementById('loader');
    const btnText = document.getElementById('btnText');
    loader.style.display = 'block';
    btnText.style.display = 'none';

    const formData = new FormData();
    formData.append('text', text);
    if(file) formData.append('file', file);

    try {
        const res = await fetch(`${API_BASE_URL}/tasks`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
        });

        const response = await res.json();  // ‚úÖ PARSE JSON

        if(res.ok) {
            // ‚úÖ CLEAR INPUTS
            document.getElementById('taskInput').value = '';
            document.getElementById('mediaInput').value = '';
            
            // ‚úÖ SHOW UPLOAD PREVIEW (if file uploaded)
            if(response.media_url) {
                showFilePreview(response);  // ‚úÖ Use helper function
            }
            
            fetchTasks();  // ‚úÖ Refresh list
        }
    } catch (err) {
        alert("Upload failed: " + err.message);
    } finally {
        loader.style.display = 'none';
        btnText.style.display = 'block';
    }
}*/
async function saveTask() {
    const text = document.getElementById('taskInput').value;
    const file = document.getElementById('mediaInput').files[0];
    const btn = document.getElementById('saveBtn');

    if (!text && !file) return;
    btn.disabled = true;

    try {
        let mediaData = { url: null, type: null, ext: null, name: null };

        if (file) {
            // STEP 1: Get Signature from Backend
            const sigFormData = new FormData();
            sigFormData.append('original_filename', file.name);

            const sigRes = await fetch(`${API_BASE_URL}/sign-upload`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                body: sigFormData
            });
            const sigData = await sigRes.json();

            // STEP 2: Upload to Cloudinary with Signature
            const cloudFormData = new FormData();
            cloudFormData.append('file', file);
            cloudFormData.append('api_key', sigData.api_key);
            cloudFormData.append('timestamp', sigData.timestamp);
            cloudFormData.append('signature', sigData.signature);
            cloudFormData.append('public_id', sigData.public_id);
            cloudFormData.append('folder', sigData.folder);

            const cloudRes = await fetch(`https://api.cloudinary.com/v1_1/${sigData.cloud_name}/auto/upload`, {
                method: 'POST',
                body: cloudFormData
            });
            const cloudJson = await cloudRes.json();
            
            mediaData = {
                url: cloudJson.secure_url,
                type: cloudJson.resource_type,
                ext: cloudJson.format,
                name: file.name
            };
        }

        // STEP 3: Save Task to Backend
        const taskFormData = new FormData();
        taskFormData.append('text', text);
        taskFormData.append('media_url', mediaData.url || "");
        taskFormData.append('media_type', mediaData.type || "");
        taskFormData.append('media_extension', mediaData.ext || "");
        taskFormData.append('original_filename', mediaData.name || "");

        await fetch(`${API_BASE_URL}/tasks`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
            body: taskFormData
        });

        location.reload();
    } catch (err) {
        alert("Upload failed: " + err.message);
        btn.disabled = false;
    }
}



    
    async function clearAllTasks() {
    const confirmation = confirm("‚ö†Ô∏è DANGER: This will delete EVERY task in the global database forever. Are you absolutely sure?");
    if (!confirmation) return;

    const token = localStorage.getItem('token');
    try {
        const res = await fetch(`${API_BASE_URL}/tasks/clear`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.ok) {
            alert("Database Wiped Successfully.");
            fetchTasks(); // Refresh the list
        } else {
            const data = await res.json();
            alert("Error: " + (data.detail || "Could not wipe database. Check Admin status."));
        }
    } catch (err) {
        alert("Server error during wipe attempt.");
    }
}
    async function deleteTask(id) {
        if(!confirm("Delete this?")) return;
        const token = localStorage.getItem('token');
        await fetch(`${API_BASE_URL}/tasks/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        fetchTasks();
    }
    
    
    async function updateStats() {
        const token = localStorage.getItem('token');
        const res = await fetch(`${API_BASE_URL}/tasks/stats`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const stats = await res.json();
        document.getElementById('totalTasks').innerText = stats.total;
        document.getElementById('completionScore').innerText = stats.completion_score;
        document.getElementById('pendingTasks').innerText = stats.pending;
    }

    async function downloadFile(url, filename) {
    try {
        // Fetch the file data
        const response = await fetch(url);
        if (!response.ok) throw new Error('Download failed');
        
        // Convert to Blob to ensure binary integrity
        const blob = await response.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename; // Forces correct extension
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    } catch (error) {
        console.error('Download error:', error);
        // Fallback if fetch fails (e.g., CORS issues)
        window.open(url, '_blank');
    }
}
    
    // Initialize
    // Initialize
window.onload = () => {
    if(localStorage.getItem('token')) showDashboard();
    
    document.getElementById('mediaInput').addEventListener('change', function() {
    const previewContainer = document.getElementById('filePreview');
    const nameLabel = document.getElementById('selectedFileName');
    
    if (this.files[0]) {
        previewContainer.style.display = 'block';
        nameLabel.innerText = `üìé Selected: ${this.files[0].name}`;
    } else {
        previewContainer.style.display = 'none';
        nameLabel.innerText = "";
    }
 });
}
</script>
</body>
</html>
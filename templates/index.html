<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow Pro Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-8">
   <div id="toast" class="z-50 fixed top-10 right-5 bg-green-600 text-white px-8 py-4 rounded-xl shadow-2xl transform -translate-y-20 opacity-0 transition-all duration-500 ease-out pointer-events-none font-bold">
        ‚úÖ Changes Saved!
    </div>
    
    <div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-2 text-blue-600">TaskFlow Pro</h1>
        
        <a href="#" id="docsLink" target="_blank" class="text-xs text-blue-400 hover:text-blue-600 underline mb-4 block">Open API Documentation ‚Üó</a>
         
        <div id="statsBar" class="grid grid-cols-3 gap-2 mb-6 text-center">
            <div class="bg-blue-50 p-2 rounded border border-blue-100">
                <p class="text-[10px] text-blue-500 uppercase font-bold">Total</p>
                <p id="totalTasks" class="text-lg font-bold text-blue-700">0</p>
            </div>
            <div class="bg-green-50 p-2 rounded border border-green-100">
                <p class="text-[10px] text-green-500 uppercase font-bold">Score</p>
                <p id="completionScore" class="text-lg font-bold text-green-700">0%</p>
            </div>
            <div class="bg-yellow-50 p-2 rounded border border-yellow-100">
                <p class="text-[10px] text-yellow-600 uppercase font-bold">Pending</p>
                <p id="pendingTasks" class="text-lg font-bold text-yellow-700">0</p>
            </div>
        </div>

        <div id="status" class="text-[10px] font-semibold mb-4 text-gray-400 uppercase tracking-widest">Connecting...</div>

        <div class="space-y-4 mb-4">
    <div class="bg-white border rounded-xl p-2 shadow-sm focus-within:ring-2 focus-within:ring-blue-400 transition">
        <div class="flex items-center gap-2">
            <input type="file" id="mediaInput" style="display: none;" accept="image/*,video/*,audio/*,gif,.pdf,.doc,.docx">
            
            <button onclick="document.getElementById('mediaInput').click()" 
                    class="p-2 text-gray-500 hover:bg-gray-100 rounded-full transition" 
                    title="Attach File or GIF">
                üìé
            </button>
            
            <input id="taskInput" type="text" 
                   placeholder="Type a task or attach a GIF..." 
                   class="flex-1 border-none focus:ring-0 text-sm outline-none bg-transparent">
            
            <button onclick="addTask()" 
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-medium text-sm">
                Send
            </button>
        </div>
        <div id="filePreview" class="text-[10px] text-blue-500 font-medium ml-10 mt-1 empty:hidden"></div>
    </div>

    <input id="searchInput" type="text" oninput="fetchTasks()" 
           placeholder="üîç Search tasks..." 
           class="w-full border p-2 rounded-lg focus:outline-none text-sm bg-gray-50">
</div>

        <ul id="taskList" class="space-y-2"></ul>

        <div class="mt-8 pt-4 border-t border-red-100">
            <button onclick="clearAllTasks()" class="w-full py-2 text-xs font-bold text-red-400 hover:text-red-600 border border-red-100 hover:border-red-200 rounded-lg transition uppercase tracking-widest">
                üóëÔ∏è Clear All Data
            </button>
            <p class="text-[10px] text-center text-gray-400 mt-4 italic">
               Last Sync: <span id="lastUpdated">Loading...</span>
            </p>
        </div>
    </div>

<script>
    const API_BASE_URL = "https://task-flow-now.onrender.com";
    const API_KEY = "RENDER_REPLACE_API_KEY"; 
    const API_URL = `${API_BASE_URL}/tasks`;

    document.getElementById('docsLink').href = `${API_BASE_URL}/docs`;

    // File selection preview
    document.getElementById('mediaInput').addEventListener('change', function() {
        const file = this.files[0];
        const preview = document.getElementById('filePreview');
        preview.innerText = file ? `üìÑ Attached: ${file.name}` : "";
    });

    // 1. THE CHEF: Helper to render each task card
    function renderTask(task) {
    let mediaHtml = "";
    const url = task.media_url;

    if (url) {
        const ext = url.split('.').pop().toLowerCase();
        let playerHtml = "";

        // 1. Generate the specific player/preview
        if (['mp4', 'webm', 'ogg', 'mov'].includes(ext)) {
            playerHtml = `
                <video controls class="rounded-lg w-full max-h-64 bg-black">
                    <source src="${url}" type="video/mp4">
                </video>`;
        } else if (['mp3', 'wav', 'm4a'].includes(ext)) {
            playerHtml = `
                <audio controls class="w-full">
                    <source src="${url}" type="audio/mpeg">
                </audio>`;
        } else if (ext === 'pdf') {
            playerHtml = `
                <div class="p-4 bg-gray-50 border border-dashed rounded-lg text-center text-blue-600 font-medium">
                    üìÑ PDF Document
                </div>`;
        } else {
            playerHtml = `<img src="${url}" class="rounded-lg max-w-full h-auto border shadow-sm">`;
        }

        // 2. Wrap everything in a container with a Download Button
        mediaHtml = `
            <div class="mt-3 flex flex-col gap-2">
                ${playerHtml}
                <a href="${url.replace('/upload/', '/upload/fl_attachment/')}" 
                   class="text-xs font-bold text-gray-500 hover:text-blue-600 flex items-center gap-1 transition-colors self-start px-2 py-1 bg-gray-100 rounded">
                   üì• DOWNLOAD FILE
                </a>
            </div>`;
    }

    return `
        <li class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-3 flex flex-col">
            <div class="flex justify-between items-start gap-3">
                <span class="text-sm font-medium text-gray-800 break-words">${task.text || "Untitled Task"}</span>
                <button onclick="deleteTask(${task.id})" class="text-gray-300 hover:text-red-500 transition">‚úï</button>
            </div>
            ${mediaHtml}
        </li>`;
}

    // 2. THE DELIVERY DRIVER: Fetching tasks from API
    async function fetchTasks() {
        const statusEl = document.getElementById('status');
        const list = document.getElementById('taskList');
        const searchTerm = document.getElementById('searchInput').value;

        try {
            const res = await fetch(`${API_URL}?Search=${searchTerm}`);
            if(!res.ok) throw new Error("Connection Failed");
            
            const tasks = await res.json();
            statusEl.innerText = "‚óè API Online";
            statusEl.className = "text-[10px] font-semibold mb-4 text-green-500 uppercase tracking-widest";

            list.innerHTML = tasks.map(task => renderTask(task)).join('');
            updateStats();
            
        } catch (err) {
            statusEl.innerText = "‚óã API Offline";
            statusEl.className = "text-[10px] font-semibold mb-4 text-red-500 uppercase tracking-widest";
        }
    }

    // 3. UPDATED STATS: Fixed URL to match main.py
    async function updateStats() {
        try {
            const res = await fetch(`${API_URL}/stats`); // This becomes /tasks/stats
            const stats = await res.json();
            
            document.getElementById('totalTasks').innerText = stats.total || 0;
            document.getElementById('completionScore').innerText = stats.completion_score || "0%";
            document.getElementById('pendingTasks').innerText = stats.pending || 0;
            
            if(stats.last_updated) {
                document.getElementById('lastUpdated').innerText = stats.last_updated;
            }
        } catch (e) {
            console.error("Stats update failed", e);
        }
    }

    // 4. ADD TASK: FormData for Media Uploads
    async function addTask() {
        const textInput = document.getElementById('taskInput');
        const fileInput = document.getElementById('mediaInput');
        
        if (!textInput.value.trim() && !fileInput.files[0]) return;

        const formData = new FormData();
        formData.append("text", textInput.value); 
        if (fileInput.files[0]) formData.append("file", fileInput.files[0]);

        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'X-API-KEY': API_KEY },
                body: formData
            });

            if (res.ok) {
                textInput.value = "";
                fileInput.value = "";
                document.getElementById('filePreview').innerText = "";
                fetchTasks();
            }
        } catch (err) {
            console.error("Add failed", err);
        }
    }

    // 5. SYSTEM ACTIONS
    async function deleteTask(id) {
        if(!confirm("Delete this task?")) return;
        await fetch(`${API_URL}/${id}`, { 
            method: 'DELETE',
            headers: { 'X-API-KEY': API_KEY }
        });
        fetchTasks();
    }

    async function clearAllTasks() {
    const password = prompt("Enter Admin Password:");
    if (!password) return;

    try {
        const res = await fetch(`${API_BASE_URL}/system/clear_memory`, {
            method: 'DELETE',
            headers: { 
                'X-API-KEY': password, // Pass the password from the prompt
                'Content-Type': 'application/json' 
            }
        });

        if (res.ok) {
            alert("üßπ Database Wiped!");
            fetchTasks(); // Refresh UI
        } else {
            alert("‚ùå Failed to clear. Check password.");
        }
    } catch (err) {
        console.error("Clear error:", err);
    }
}

    window.onload = () => {
        document.getElementById('taskInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') addTask(); });
        fetchTasks();
    };
</script>
</body>
</html>
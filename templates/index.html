<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow Pro Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            width: 20px; height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; border-top-color: #fff;
            animation: spin 1s ease-in-out infinite; display: none; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn-loading { pointer-events: none; opacity: 0.7; }
    </style>
</head>

<body class="bg-gray-100 p-4 md:p-8">
    
    <div id="authSection" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm">
            <h2 id="authTitle" class="text-3xl font-bold mb-2 text-blue-600">Login</h2>
            <p id="authSub" class="text-gray-400 text-sm mb-6">Welcome back to TaskFlow</p>
            <div class="space-y-4">
                <input type="text" id="authUser" placeholder="Username" class="w-full p-3 border rounded-xl outline-none">
                <input type="password" id="authPass" placeholder="Password" class="w-full p-3 border rounded-xl outline-none">
                <button onclick="handleAuth()" id="authBtn" class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold hover:bg-blue-700 transition">Login</button>
                <p class="text-center text-sm text-gray-500">
                    <span id="toggleText">Need an account?</span> 
                    <a href="#" onclick="toggleAuthMode()" id="authToggle" class="text-blue-600 font-bold underline ml-1">Signup</a>
                </p>
            </div>
        </div>
    </div>

    <div id="dashboard" class="max-w-md mx-auto bg-white p-6 rounded-2xl shadow-lg" style="display: none;">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="text-2xl font-bold text-blue-600">TaskFlow Pro</h1>
                <p id="userGreeting" class="text-[10px] text-gray-400 font-bold uppercase tracking-widest"></p>
            </div>
            <button onclick="logout()" class="text-[10px] bg-gray-100 px-2 py-1 rounded font-bold text-gray-500 hover:bg-red-50">LOGOUT</button>
        </div>

        <div id="statsBar" class="grid grid-cols-3 gap-2 mb-6 text-center">
            <div class="bg-blue-50 p-2 rounded-xl border border-blue-100">
                <p class="text-[10px] text-blue-500 uppercase font-bold">Total</p>
                <p id="totalTasks" class="text-lg font-bold text-blue-700">0</p>
            </div>
            <div class="bg-green-50 p-2 rounded-xl border border-green-100">
                <p class="text-[10px] text-green-500 uppercase font-bold">Score</p>
                <p id="completionScore" class="text-lg font-bold text-green-700">0%</p>
            </div>
            <div class="bg-yellow-50 p-2 rounded-xl border border-yellow-100">
                <p class="text-[10px] text-yellow-600 uppercase font-bold">Pending</p>
                <p id="pendingTasks" class="text-lg font-bold text-yellow-700">0</p>
            </div>
        </div>

        <div class="space-y-4 mb-4">
            <div id="progressContainer" class="w-full bg-gray-100 rounded-full h-2 overflow-hidden hidden">
                <div id="uploadProgress" class="bg-blue-600 h-full transition-all" style="width: 0%"></div>
            </div>

            <div class="bg-white border rounded-xl p-3 shadow-sm">
                <div class="flex items-center gap-2">
                    <input type="file" id="mediaInput" style="display: none;" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.zip,.7z">
                    <button onclick="document.getElementById('mediaInput').click()" class="p-2 text-gray-400 hover:bg-gray-100 rounded-full">üìé</button>
                    <input id="taskInput" type="text" placeholder="What's the task?" class="flex-1 text-sm outline-none">
                    <button id="sendBtn" onclick="saveTask()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm flex items-center gap-2">
                        <span id="btnText">Save</span>
                        <div id="loader" class="spinner"></div>
                    </button>
                </div>
                
                <div id="filePreview" class="mt-2 hidden">
                    <div class="flex items-center gap-3 p-2 bg-blue-50 rounded-lg border border-blue-100">
                        <span id="thumbPlaceholder" class="text-xl">üìÑ</span>
                        <span id="selectedFileName" class="text-[10px] text-blue-700 font-bold truncate flex-1"></span>
                        <button onclick="resetFileInput()" class="text-gray-400 hover:text-red-500 text-xs">‚úï</button>
                    </div>
                </div>
            </div>
            <input id="searchInput" type="text" oninput="fetchTasks()" placeholder="üîç Search tasks..." class="w-full border p-2 rounded-xl text-sm bg-gray-50">
        </div>

        <ul id="taskList" class="space-y-3"></ul>

        <div id="adminSection" class="mt-8 pt-4 border-t-2 border-red-100 hidden">
            <button onclick="clearAllTasks()" class="w-full p-3 bg-red-50 text-red-700 border-2 border-red-100 rounded-xl font-black text-[10px] uppercase">
                ‚ö†Ô∏è WIPE GLOBAL DATABASE (ADMIN ONLY)
            </button>
        </div>
    </div>

<script>
    const API_BASE_URL = "https://taskflow-backendprosecure.onrender.com";
    let isLoginMode = true;

    // --- UTILS ---
    function escapeHtml(text) {
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
        return text ? text.replace(/[&<>"']/g, m => map[m]) : "";
    }

    function resetFileInput() {
        document.getElementById('mediaInput').value = '';
        document.getElementById('filePreview').classList.add('hidden');
    }

    // --- AUTH ---
    function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        document.getElementById('authTitle').innerText = isLoginMode ? 'Login' : 'Sign Up';
        document.getElementById('authBtn').innerText = isLoginMode ? 'Login' : 'Create Account';
        document.getElementById('authToggle').innerText = isLoginMode ? "Signup" : "Login";
    }

    async function handleAuth() {
        const username = document.getElementById('authUser').value;
        const password = document.getElementById('authPass').value;
        const endpoint = isLoginMode ? '/login' : '/signup';
        if(!username || !password) return alert("Fill fields");

        try {
            const res = await fetch(`${API_BASE_URL}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();
            if (res.ok) {
                if (isLoginMode) {
                    localStorage.setItem('token', data.access_token);
                    localStorage.setItem('username', username);
                    localStorage.setItem('isAdmin', data.is_admin);
                    showDashboard();
                } else {
                    alert("Success! Now Login.");
                    toggleAuthMode();
                }
            } else alert(data.detail);
        } catch (err) { alert("Server Offline"); }
    }

    function showDashboard() {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        if (localStorage.getItem('isAdmin') === 'true') {
            document.getElementById('adminSection').classList.remove('hidden');
        }
        document.getElementById('userGreeting').innerText = `Hello, ${localStorage.getItem('username')}`;
        fetchTasks();
    }

    function logout() { localStorage.clear(); location.reload(); }

    // --- SIGNED UPLOADS & TASK SAVING ---
    async function saveTask() {
        const text = document.getElementById('taskInput').value;
        const file = document.getElementById('mediaInput').files[0];
        const btn = document.getElementById('sendBtn');
        const loader = document.getElementById('loader');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('uploadProgress');

        if (!text && !file) return;

        btn.disabled = true;
        loader.style.display = 'block';
        let mediaData = { url: null, type: null, ext: null, name: null };

        try {
            if (file) {
                progressContainer.classList.remove('hidden');
                // 1. Get Signature
                const sigFormData = new FormData();
                sigFormData.append('original_filename', file.name);

                const sigRes = await fetch(`${API_BASE_URL}/sign-upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: sigFormData
                });
                const sigData = await sigRes.json();

                // 2. Upload to Cloudinary (XHR for progress)
                const cloudJson = await new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    const cloudFormData = new FormData();
                    cloudFormData.append('file', file);
                    cloudFormData.append('api_key', sigData.api_key);
                    cloudFormData.append('timestamp', sigData.timestamp);
                    cloudFormData.append('signature', sigData.signature);
                    cloudFormData.append('public_id', sigData.public_id);
                    cloudFormData.append('folder', sigData.folder);

                    xhr.upload.onprogress = (e) => {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = percent + '%';
                    };
                    xhr.open('POST', `https://api.cloudinary.com/v1_1/${sigData.cloud_name}/auto/upload`);
                    xhr.onload = () => resolve(JSON.parse(xhr.responseText));
                    xhr.onerror = () => reject("Cloudinary Upload Failed");
                    xhr.send(cloudFormData);
                });

                mediaData = {
                    url: cloudJson.secure_url,
                    type: cloudJson.resource_type,
                    ext: cloudJson.format,
                    name: file.name
                };
            }

            // 3. Save to Backend
            const taskFormData = new FormData();
            taskFormData.append('text', text);
            taskFormData.append('media_url', mediaData.url || "");
            taskFormData.append('media_type', mediaData.type || "");
            taskFormData.append('media_extension', mediaData.ext || "");
            taskFormData.append('original_filename', mediaData.name || "");

            await fetch(`${API_BASE_URL}/tasks`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                body: taskFormData
            });

            document.getElementById('taskInput').value = '';
            resetFileInput();
            fetchTasks();
        } catch (err) {
            alert("Error: " + err);
        } finally {
            btn.disabled = false;
            loader.style.display = 'none';
            progressContainer.classList.add('hidden');
        }
    }

    async function fetchTasks() {
        const searchTerm = document.getElementById('searchInput').value;
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
            const res = await fetch(`${API_BASE_URL}/tasks?Search=${searchTerm}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const tasks = await res.json();
            const list = document.getElementById('taskList');
            list.innerHTML = tasks.map(task => renderTask(task)).join('');
            updateStats();
        } catch (err) { console.error(err); }
    }

    function renderTask(task) {
        const currentUser = localStorage.getItem('username');
        const isAdmin = localStorage.getItem('isAdmin') === 'true';
        let mediaHtml = "";

        if (task.media_url) {
            const ext = (task.media_extension || task.media_url.split('.').pop()).toLowerCase();
            const isImg = ['jpg','jpeg','png','gif','webp'].includes(ext);
            const isVid = ['mp4','webm','mov'].includes(ext);
            
            let preview = `<div class="p-4 bg-gray-50 rounded-xl border-2 border-dashed text-center">üìÑ ${ext.toUpperCase()} File</div>`;
            if(isImg) preview = `<img src="${task.media_url}" class="rounded-xl w-full">`;
            if(isVid) preview = `<video controls class="rounded-xl w-full"><source src="${task.media_url}"></video>`;

            mediaHtml = `<div class="mt-3">${preview}</div>`;
        }

        const deleteBtn = (task.owner === currentUser || isAdmin) ? `<button onclick="deleteTask(${task.id})" class="text-red-300">‚úï</button>` : "";

        return `
            <li class="bg-white p-4 rounded-2xl border shadow-sm mb-4">
                <div class="flex justify-between">
                    <div>
                        <span class="text-[9px] bg-blue-100 text-blue-600 px-2 rounded-full font-bold uppercase">${task.owner}</span>
                        <p class="text-sm font-medium mt-1">${escapeHtml(task.text)}</p>
                    </div>
                    ${deleteBtn}
                </div>
                ${mediaHtml}
            </li>`;
    }

    async function updateStats() {
        const res = await fetch(`${API_BASE_URL}/tasks/stats`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        const stats = await res.json();
        document.getElementById('totalTasks').innerText = stats.total;
        document.getElementById('completionScore').innerText = stats.completion_score;
        document.getElementById('pendingTasks').innerText = stats.pending;
    }

    async function deleteTask(id) {
        if(!confirm("Delete?")) return;
        await fetch(`${API_BASE_URL}/tasks/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        fetchTasks();
    }

    window.onload = () => {
        if(localStorage.getItem('token')) showDashboard();
        document.getElementById('mediaInput').addEventListener('change', function() {
            if (this.files[0]) {
                document.getElementById('filePreview').classList.remove('hidden');
                document.getElementById('selectedFileName').innerText = this.files[0].name;
            }
        });
    }
</script>
</body>
</html>
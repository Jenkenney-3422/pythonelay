<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow Pro Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .btn-loading {
            pointer-events: none;
            opacity: 0.7;
        }
    </style>
</head>

<body class="bg-gray-100 p-8 min-h-screen">
    <!-- Toast Notification - Fixed positioning -->
    <div id="toast" class="fixed top-4 right-4 z-50 bg-green-600 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-0 opacity-0 transition-all duration-500 ease-out pointer-events-none font-semibold max-w-sm">
        ‚úÖ Changes Saved!
    </div>
    
    <!-- Main Container -->
    <div class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-2xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold mb-3 bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent">TaskFlow Pro</h1>
            <a href="#" id="docsLink" target="_blank" class="text-sm text-blue-500 hover:text-blue-700 underline transition-colors">üìö Open API Documentation ‚Üó</a>
        </div>
        
        <!-- Stats Bar -->
        <div id="statsBar" class="grid grid-cols-3 gap-4 mb-8 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl">
            <div class="text-center">
                <p class="text-xs text-blue-500 uppercase font-bold tracking-wide">Total</p>
                <p id="totalTasks" class="text-2xl font-bold text-blue-700 mt-1">0</p>
            </div>
            <div class="text-center">
                <p class="text-xs text-green-500 uppercase font-bold tracking-wide">Score</p>
                <p id="completionScore" class="text-2xl font-bold text-green-700 mt-1">0%</p>
            </div>
            <div class="text-center">
                <p class="text-xs text-yellow-600 uppercase font-bold tracking-wide">Pending</p>
                <p id="pendingTasks" class="text-2xl font-bold text-yellow-700 mt-1">0</p>
            </div>
        </div>

        <!-- Status Indicator -->
        <div id="status" class="text-xs font-bold mb-6 text-gray-500 uppercase tracking-widest text-center">Connecting...</div>

        <!-- Input Section -->
        <div class="space-y-4 mb-8">
            <!-- Task Input with File Attachment -->
            <div class="bg-gradient-to-r from-gray-50 to-blue-50 border-2 border-dashed border-blue-100 rounded-2xl p-4 hover:shadow-md transition-all focus-within:border-blue-300 focus-within:shadow-lg">
                <div class="flex items-center gap-3">
                    <input type="file" id="mediaInput" class="hidden" accept="image/*,video/*,audio/*,gif,.pdf,.doc,.docx">
                    <button onclick="document.getElementById('mediaInput').click()" 
                            class="p-3 text-xl text-gray-500 hover:bg-blue-100 hover:text-blue-600 rounded-2xl transition-all shadow-sm hover:shadow-md w-12 h-12 flex items-center justify-center"
                            title="Attach File or GIF">
                        üìé
                    </button>
                    
                    <input id="taskInput" type="text" 
                           placeholder="üí° Type a task or attach a GIF..."
                           class="flex-1 border-none focus:ring-0 text-base outline-none bg-transparent py-3">
                    
                    <button id="sendBtn" onclick="addTask()" 
                            class="flex items-center justify-center gap-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all font-semibold">
                        <span id="btnText">Send</span>
                        <div id="loader" class="spinner hidden"></div>
                    </button>
                </div>
                <div id="filePreview" class="text-xs text-blue-500 font-medium mt-2 ml-16 opacity-0 transition-opacity"></div>
            </div>

            <!-- Search Input -->
            <div class="relative">
                <input id="searchInput" type="text" oninput="fetchTasks()" 
                       placeholder="üîç Search tasks..." 
                       class="w-full pl-12 pr-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-blue-400 focus:ring-4 focus:ring-blue-100 bg-white shadow-sm hover:shadow-md transition-all text-sm">
                <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">üîç</div>
            </div>
        </div>

        <!-- Task List -->
        <div class="space-y-3 mb-8 max-h-96 overflow-y-auto">
            <ul id="taskList"></ul>
        </div>

        <!-- Footer Actions -->
        <div class="pt-8 border-t-2 border-gray-100 space-y-4">
            <button onclick="clearAllTasks()" 
                    class="w-full py-4 px-6 text-sm font-bold text-red-500 hover:text-red-700 bg-red-50 hover:bg-red-100 border-2 border-red-200 hover:border-red-300 rounded-xl transition-all shadow-sm hover:shadow-md uppercase tracking-wider">
                üóëÔ∏è Clear All Data
            </button>
            <p class="text-xs text-center text-gray-500 italic">
                Last Sync: <span id="lastUpdated" class="font-mono">Loading...</span>
            </p>
        </div>
    </div>

<script>
    const API_BASE_URL = "https://task-flow-now.onrender.com";
    const API_KEY = "RENDER_REPLACE_API_KEY"; 
    const API_URL = `${API_BASE_URL}/tasks`;

    // Set docs link
    document.getElementById('docsLink').href = `${API_BASE_URL}/docs`;

    // File preview handler
    document.getElementById('mediaInput').addEventListener('change', function() {
        const file = this.files[0];
        const preview = document.getElementById('filePreview');
        if (file) {
            preview.textContent = `üìÑ Attached: ${file.name}`;
            preview.classList.remove('opacity-0');
        } else {
            preview.textContent = '';
            preview.classList.add('opacity-0');
        }
    });

    // Task rendering function
    function renderTask(task) {
        let mediaHtml = "";
        const url = task.media_url;

        if (url) {
            const ext = url.split('.').pop().toLowerCase();
            let playerHtml = "";

            if (['mp4', 'webm', 'ogg', 'mov'].includes(ext)) {
                playerHtml = `<video controls class="rounded-xl w-full max-h-48 bg-black shadow-md">`;
            } else if (['mp3', 'wav', 'm4a'].includes(ext)) {
                playerHtml = `<audio controls class="w-full rounded-xl shadow-md">`;
            } else if (ext === 'pdf') {
                playerHtml = `<div class="p-4 bg-red-50 border-2 border-dashed border-red-200 rounded-xl text-center text-red-600 font-semibold shadow-sm">üìÑ PDF Document</div>`;
            } else if (['doc', 'docx'].includes(ext)) {
                playerHtml = `<div class="p-4 bg-blue-50 border-2 border-dashed border-blue-200 rounded-xl text-center text-blue-700 font-semibold shadow-sm">üìù Word Document (.${ext})</div>`;
            } else {
                playerHtml = `<img src="${url}" class="rounded-xl max-w-full h-auto border shadow-md" alt="Media">`;
            }

            mediaHtml = `
                <div class="mt-4 p-4 bg-gray-50 rounded-xl border">
                    ${playerHtml}
                    <a href="${url.replace('/upload/', '/upload/fl_attachment/')}" 
                       class="mt-2 inline-block text-xs font-bold text-blue-600 hover:text-blue-800 bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded-full transition-all">
                        üì• DOWNLOAD
                    </a>
                </div>`;
        }

        return `
            <li class="group bg-gradient-to-r from-white to-gray-50 p-6 rounded-2xl shadow-lg border border-gray-200 hover:shadow-2xl hover:-translate-y-1 transition-all duration-300">
                <div class="flex justify-between items-start gap-4">
                    <span class="text-base font-semibold text-gray-800 leading-relaxed break-words flex-1 pr-4 group-hover:text-gray-900">${task.text || "Untitled Task"}</span>
                    <button onclick="deleteTask(${task.id})" 
                            class="text-gray-400 hover:text-red-500 hover:bg-red-100 p-2 rounded-xl transition-all group-hover:scale-110">
                        ‚úï
                    </button>
                </div>
                ${mediaHtml}
            </li>`;
    }

    // Fetch tasks with search
    async function fetchTasks() {
        const statusEl = document.getElementById('status');
        const list = document.getElementById('taskList');
        const searchTerm = document.getElementById('searchInput').value;

        try {
            statusEl.textContent = "üîÑ Loading...";
            statusEl.className = "text-xs font-bold mb-6 text-blue-500 uppercase tracking-widest text-center";
            
            const res = await fetch(`${API_URL}?Search=${encodeURIComponent(searchTerm)}`);
            if (!res.ok) throw new Error("Connection Failed");
            
            const tasks = await res.json();
            statusEl.textContent = "‚úÖ API Online";
            statusEl.className = "text-xs font-bold mb-6 text-green-600 uppercase tracking-widest text-center";

            list.innerHTML = tasks.map(task => renderTask(task)).join('');
            updateStats();
            
        } catch (err) {
            statusEl.textContent = "‚ùå API Offline";
            statusEl.className = "text-xs font-bold mb-6 text-red-500 uppercase tracking-widest text-center";
            list.innerHTML = '';
        }
    }

    // Update stats
    async function updateStats() {
        try {
            const res = await fetch(`${API_URL}/stats`);
            const stats = await res.json();
            
            document.getElementById('totalTasks').textContent = stats.total || 0;
            document.getElementById('completionScore').textContent = stats.completion_score || "0%";
            document.getElementById('pendingTasks').textContent = stats.pending || 0;
            
            if (stats.last_updated) {
                document.getElementById('lastUpdated').textContent = stats.last_updated;
            }
        } catch (e) {
            console.error("Stats update failed", e);
        }
    }

    // Add new task
    async function addTask() {
        const textInput = document.getElementById('taskInput');
        const mediaInput = document.getElementById('mediaInput');
        const sendBtn = document.getElementById('sendBtn');
        const btnText = document.getElementById('btnText');
        const loader = document.getElementById('loader');
        const preview = document.getElementById('filePreview');

        if (!textInput.value.trim() && !mediaInput.files[0]) return;

        // Loading state
        sendBtn.classList.add('btn-loading');
        btnText.classList.add('hidden');
        loader.classList.remove('hidden');

        const formData = new FormData();
        formData.append('text', textInput.value.trim());
        if (mediaInput.files[0]) {
            formData.append('file', mediaInput.files[0]);
        }

        try {
            const res = await fetch(`${API_URL}`, {
                method: 'POST',
                headers: { 'X-API-KEY': API_KEY },
                body: formData
            });

            if (res.ok) {
                textInput.value = '';
                mediaInput.value = '';
                preview.classList.add('opacity-0');
                preview.textContent = '';
                await fetchTasks();
                showToast();
            }
        } catch (err) {
            console.error("Upload failed", err);
            alert("Upload failed. Try a smaller file!");
        } finally {
            sendBtn.classList.remove('btn-loading');
            btnText.classList.remove('hidden');
            loader.classList.add('hidden');
        }
    }

    // Delete task
    async function deleteTask(id) {
        if (!confirm("Delete this task permanently?")) return;
        try {
            await fetch(`${API_URL}/${id}`, { 
                method: 'DELETE',
                headers: { 'X-API-KEY': API_KEY }
            });
            await fetchTasks();
        } catch (err) {
            console.error("Delete failed", err);
        }
    }

    // Clear all tasks
    async function clearAllTasks() {
        const password = prompt("Enter Admin Password to confirm:");
        if (!password) return;

        try {
            const res = await fetch(`${API_BASE_URL}/system/clear_memory`, {
                method: 'DELETE',
                headers: { 
                    'X-API-KEY': password,
                    'Content-Type': 'application/json' 
                }
            });

            if (res.ok) {
                alert("üßπ All data cleared successfully!");
                await fetchTasks();
            } else {
                alert("‚ùå Failed to clear. Check password.");
            }
        } catch (err) {
            console.error("Clear error:", err);
            alert("‚ùå Network error. Please try again.");
        }
    }

    // Show toast notification
    function showToast() {
        const toast = document.getElementById('toast');
        toast.classList.remove('opacity-0', 'translate-y-0');
        toast.classList.add('opacity-100', 'translate-y-0');
        
        setTimeout(() => {
            toast.classList.remove('opacity-100', 'translate-y-0');
            toast.classList.add('opacity-0');
        }, 3000);
    }

    // Initialize
    window.onload = () => {
        document.getElementById('taskInput').addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') addTask(); 
        });
        fetchTasks();
        updateStats();
    };
</script>
</body>
</html>